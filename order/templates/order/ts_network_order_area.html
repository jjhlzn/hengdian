{% extends "order/base_generic.html" %}
{% load static from staticfiles %}
{% load hengdian_extras %}

{% block title %}网络订单区域分析{% endblock %}

{% block content %}
<div style="width:100%">
        <div class="row">
             <div class="col-md-12">
                 <div class="row">
                     <div class="col-md-4">
                         <div class="dropdown">
                              <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu2" data-toggle="dropdown">
                                选择年份
                                <span class="caret"></span>
                              </button>
                              <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu2">
                                <li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="change_dataset('year', '2014', '2014')">2014</a></li>
                                <li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="change_dataset('year', '2013', '2013')">2013</a></li>
                                <li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="change_dataset('year', '2012', '2012')">2012</a></li>
                              </ul>
                              <span id="lbl_year">2014年</span>
                         </div>
                     </div>
                     <div class="col-md-4">
                         <div class="dropdown">
                              <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown">
                                选择指标指标
                                <span class="caret"></span>
                              </button>
                              <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                                <li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="change_dataset('indicator', 'people_count', '人数')">人数</a></li>
                                <li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="change_dataset('indicator','total_money', '营收')">营收</a></li>
                                <li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="change_dataset('indicator', 'order_count', '订单数')">订单数</a></li>
                              </ul>
                              <span id="lbl_indicator">人数</span>
                          </div>
                      </div>

                     <div class="col-md-4">
                         <div class="dropdown">
                              <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown">
                                是否实际售票数据
                                <span class="caret"></span>
                              </button>
                              <ul class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                                <li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="change_dataset('is_real_sell_info','0', '否')">否</a></li>
                                <li role="presentation"><a role="menuitem" tabindex="-1" href="#" onclick="change_dataset('is_real_sell_info', '1', '是')">是</a></li>
                              </ul>
                             <span id="lbl_is_real_sell_info">否</span>
                          </div>
                      </div>
                 </div>
            </div>
        </div>
        <div>
            <div class="row">
                <div class="col-md-6 labeled-chart-container">
                    <div class="canvas-holder">
                         <canvas id="canvas" height="150" width="300"></canvas>
                    </div>
                </div>
                <div class="col-md-6 labeled-chart-container">
                    <div class="canvas-holder">
                         <canvas id="canvas1" height="150" width="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 labeled-chart-container">
                    <table id="table_province" width="100%">

                    </table>
                </div>
                <div class="col-md-6 labeled-chart-container" >
                    <table id="table_city" width="100%">

                    </table>
                </div>
            </div>
        </div>
</div>
{% endblock %}
{% block javascript %}
	<script src="{% static "order/js/Chart.js" %}"></script>
	<script>
        var datasets = {}
        var datasets_src;
        var datasets1 = {}
        var datasets1_src;
        var params = {};
		window.onload = function() {
                params['year'] = '2014'
                params['indicator'] = 'people_count'
                params['is_real_sell_info'] = '0'
                $.ajax({
                     type: "GET",
                     url: "/order/json/ts_network_order_area",
                     data: {year: params['year'], indicator: params['indicator'], is_real_sell_info: params['is_real_sell_info']},
                     dataType: "json",
                     success: deal_resonse_json
                 });
        };

        function deal_resonse_json(respJSON) {
            if (respJSON.status != 0) {
                alert('服务器返回错误（status = ' + respJSON.status+", message = " +respJSON.message + ')');
                return;
            }
            params = respJSON.data.params;
            datasets = respJSON.data.datasets;
            datasets_src = respJSON.data.datasets_src;
            datasets1 = respJSON.data.datasets1;
            datasets1_src = respJSON.data.datasets1_src;

            draw_lines({responsive: true,
                        pointHitDetectionRadius: 1,
                        datasetFill : false,
                        pointDot: respJSON.data.pointDot});
        }
		
		function change_dataset(key, value, desc) {
            window.pie.destroy();
            window.pie1.destroy();
            document.getElementById('table_province').innerHTML = "";
            document.getElementById('table_city').innerHTML = "";
            params[key] = value;
            $('#lbl_'+key).html(desc);
            $("ul.pie-legend").remove();
            $.ajax({
                 type: "GET",
                 url: "/order/json/ts_network_order_area",
                 data: {year: params.year,  indicator: params.indicator, is_real_sell_info: params.is_real_sell_info},
                 dataType: "json",
                 success: deal_resonse_json
             });
        }

        function draw_graph(canvas_id, datasets, datasets_src, graph_name, table_id, options) {
            var ctx = document.getElementById(canvas_id).getContext("2d");
			window[graph_name] = new Chart(ctx).Pie(datasets, options );

            var legendHolder = $("<div id='" + canvas_id + "_legend'>")[0];
		    legendHolder.innerHTML = window[graph_name].generateLegend();
		    // Include a html legend template after the module doughnut itself

		    document.getElementById(canvas_id).parentNode.parentNode.appendChild(legendHolder.firstChild);

            var table1 = document.getElementById(table_id);

            for(var i = 0; i < datasets_src.length; i++ ) {
                var tr = document.createElement('tr');
                var td1 = document.createElement('td');
                td1.innerHTML = datasets_src[i].label;
                var td2 = document.createElement('td');
                td2.innerHTML = datasets_src[i].value;
                var td3 = document.createElement('td');
                td3.innerHTML = datasets_src[i].percent;
                tr.appendChild(td1);
                tr.appendChild(td2);
                tr.appendChild(td3);
                table1.appendChild(tr);
            }
        }

        function draw_lines(options) {
            draw_graph('canvas', datasets, datasets_src,'pie', 'table_province', options);
            draw_graph('canvas1', datasets1, datasets1_src, 'pie1', 'table_city', options);
        }

	</script>
{% endblock %}
